#!/usr/bin/env node

/**
 * 导入模块
 */
const app = require('../src/app');
const http = require('http');
const os = require('os');
const chalk = require('chalk');
const { PORT } = require('../src/config');

/**
 * 从环境或者配置文件中获取端口号
 */
const port = normalizePort(process.env.PORT || PORT);
// app.set('port', port);

/**
 * 创建 HTTP 服务
 */
const server = http.createServer(app.callback());

/**
 * 监听网络接口上提供的端口
 */
server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * 将端口规范化为数字、字符串或false
 */
function normalizePort(val) {
  const port = parseInt(val, 10);

  if (isNaN(port)) {
    // named pipe
    return val;
  }

  if (port >= 0) {
    // port number
    return port;
  }

  return false;
}

/**
 * HTTP服务器 “error” 事件的事件侦听器
 */
function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }

  const bind = typeof port === 'string' ? 'Pipe ' + port : 'Port ' + port;

  // 使用消息处理特定的侦听错误
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * 获取本地的ip地址
 * @returns 本地的ip地址
 */
function getIPAdress() {
  // os.networkInterfaces()方法返回被赋予网络地址的网络接口
  const interfaces = os.networkInterfaces();
  /*
		address: 被赋予的IPv4 or IPv6
		netmask: IPv4 or IPv6 子网掩码
		family: IPv4 or IPv6
		mac: 网络接口的MAC地址
		internal: 如果网络接口是loopback或相似的远程不能用的接口时 值true 否则值为false
		scopeid: IPv6数字领域识别码（family为IPv6才可用）
		cidr: 以CIDR表示法分配的带有路由前缀的IPv4或IPv6地址，如果netmask参数不可用 该属性为null
	*/
  for (const devName in interfaces) {
    const iface = interfaces[devName];
    for (let i = 0; i < iface.length; i++) {
      const alias = iface[i];
      if (alias.family === 'IPv4' && alias.address !== '127.0.0.1' && !alias.internal) {
        return alias.address;
      }
    }
  }
}

/**
 * 侦听 HTTP服务器
 */
function onListening() {
  const myHost = getIPAdress();
  const Local = `http://localhost:${port}`; // 本地地址
  const Network = `http://${myHost}:${port}`; // 本地ip网络地址
  console.log('server run at');
  console.log(`   - Local:   ${chalk.blue(Local)}`);
  console.log(`   - Network: ${chalk.blue(Network)}`);
}
